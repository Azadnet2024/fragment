<!DOCTYPE html>
<html lang="en">
<head>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        h1 {
            color: #008080;
            text-align: center;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 16px;
            color: #555;
            text-align: center;
            margin-bottom: 15px;
        }

        h3 {
            font-size: 12px;
            color: #555;
            text-align: center;
            margin-bottom: 15px;
        }


        main {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        form {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 300px;
            text-align: left;
            margin-left: 20px;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        button {
            background-color: #008080;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 20px;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #005757;
        }

        button[id="downloadButton"] {
            background-color: #FF0000;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 20px;
            margin-top: 10px;
        }
        
        button[id="downloadButton"]:hover {
            background-color: #eee;
        }

        .output-container {
            width: 600px;
            margin-left: 10px;
            position: relative;
            max-height: 300px;
            font-size: 14px;
            overflow-y: auto;
        }

        .config-output-container {
            width: 600px;
            margin-left: 20px;
            position: relative;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
        }
        
        footer {
            font-family: sans-serif;
            text-align: center;
            margin-top: 20px;
            color: #555;
        }
    </style>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPIran Fragment Generator</title>
</head>
<body>

    
    <h1>OPIran Subscription Fragment Generator</h1>
    <h2>پس از ایجاد کد با استفاده از فرم، کانفیگ را کپی کرده و در کلودفلر ورکر قرار دهید یا می توانید از دپلوی در کلودفلر استفاده کنید
    اکنون دامنه ورکر شما لینک اشتراک شماست</h2>

    <main>
        <form id="configForm">

    <label for="cleanIP">Clean IP / Domain:</label>
    <input type="text" id="cleanIP" name="cleanIP" style="margin-bottom: 10px;" placeholder="محل قرارگیری آی پی تمیز یا دامنه" required><br>

    <label for="yourDomain">Your Domain:</label>
    <input type="text" id="yourDomain" name="yourDomain" style="margin-bottom: 10px;" placeholder="محل قرارگیری دامنه کانفیگ یا وپن" required><br>

    <!-- Add margin-bottom to create space between questions -->
    <label for="port">Port:</label>
    <select id="port" name="port" style="margin-bottom: 10px;">
      <option value="443">443</option>
            <option value="8443">8443</option>
            <option value="2053">2053</option>
            <option value="2096">2096</option>
            <option value="2087">2087</option>
            <option value="2083">2083</option>
            <option value="80">80</option>
            <option value="8080">8080</option>
            <option value="8880">8880</option>
            <option value="2052">2052</option>
            <option value="2082">2082</option>
            <option value="2086">2086</option>
            <option value="2095">2095</option>
        </select><br>

        <h3>
            HTTP  port:  80, 8080, 8880, 2052, 2082, 2086, 2095
            HTTPS port: 443, 2053, 2083, 2087, 2096, 8443
        </h3>

    <label for="userUUID">User UUID:</label>
    <input type="text" id="userUUID" name="userUUID" style="margin-bottom: 10px;" placeholder="محل قرارگیری یوآیدی کانفیگ" required><br>

    <label for="protocol">Protocol:</label>
    <select id="protocol" name="protocol" style="margin-bottom: 10px;">
       <option value="vless">VLESS</option>
            <option value="vmess">VMESS</option>
        </select><br>

    <label for="path">Path (?ed=2048):</label>
    <input type="text" id="path" name="path" style="margin-bottom: 10px;" placeholder="Enter Path"><br>

    <!-- Add margin-bottom to create space between questions -->
    <label for="tls">Enable TLS:</label>
    <input type="checkbox" id="tls" name="tls"><br>

    <label for="mux">Enable Mux:</label>
    <input type="checkbox" id="mux" style="margin-bottom: 5px;" name="mux"><br>

    <label for="block">ِDirect Iran and China domains:</label>
    <input type="checkbox" id="block" style="margin-bottom: 5px;" name="block"><br>

    <label for="allowInsecure">Allow Insecure:</label>
    <input type="checkbox" id="allowInsecure" style="margin-bottom: 5px;" name="allowInsecure"><br>

    <label for="allowEarlyData">Allow Early Data (TCP non delay):</label>
    <input type="checkbox" id="allowEarlyData" style="margin-bottom: 5px;" name="allowEarlyData"><br>

    <button type="button" onclick="generateConfig()">Generate Configuration</button>
    <button id="downloadButton" type="button" onclick="downloadConfig()" disabled>Download Configuration</button>
</form>
        
        <div class="output-container">
            <pre id="configOutput"></pre>
        </div>
    </main>

    <a href="https://deploy.workers.cloudflare.com/?url=https://github.com/GregBrimble/cf-workers-typescript-template&paid=true" target="_blank">
      <img src="https://deploy.workers.cloudflare.com/button?paid=true" alt="Deploy to Cloudflare Workers" />
    </a>
    
    <footer>© Prepared by <a href="https://github.com/opiran-club">Farzad</a></footer>
    
    <script>
function generateConfig() {
    const cleanIP = document.getElementById('cleanIP').value;
    const yourDomain = document.getElementById('yourDomain').value;
    const port = document.getElementById('port').value;
    const userUUID = document.getElementById('userUUID').value;
    const path = document.getElementById('path').value;
    const tls = document.getElementById('tls').checked;
    const mux = document.getElementById('mux').checked;
    const block = document.getElementById('block').checked;
    const allowInsecure = document.getElementById('allowInsecure').checked;
    const allowEarlyData = document.getElementById('allowEarlyData').checked;
    const selectedProtocol = document.getElementById('protocol').value;
    const portsList = [443, 8443, 2053, 2096, 2087, 2083, 80, 8080, 8880, 2052, 2082, 2086, 2095];
    const randomizedDomain = yourDomain.toLowerCase().split('').map(char => Math.random() > 0.5 ? char.toUpperCase() : char.toLowerCase()).join('');
    const randomPath = path;
    const config = {
        "log": {
            "access": "",
            "error": "",
            "loglevel": "warning"
        },
        "inbounds": [
            {
                "tag": "socks",
                "port": 10808,
                "listen": "127.0.0.1",
                "protocol": "socks",
                "sniffing": {
                    "enabled": true,
                    "destOverride": [
                        "http",
                        "tls"
                    ],
                    "routeOnly": false
                },
                "settings": {
                    "auth": "noauth",
                    "udp": true,
                    "allowTransparent": false
                }
            },
            {
                "tag": "http",
                "port": 10809,
                "listen": "127.0.0.1",
                "protocol": "http",
                "sniffing": {
                    "enabled": true,
                    "destOverride": [
                        "http",
                        "tls"
                    ],
                    "routeOnly": false
                },
                "settings": {
                    "auth": "noauth",
                    "udp": true,
                    "allowTransparent": false
                }
            }
        ],
        "outbounds": [
            {
                "tag": "proxy",
                "protocol": selectedProtocol ? "vless" : "vmess",
                "settings": {
                    "vnext": [
                        {
                            "address": cleanIP,
                            "port": port,
                            "users": [
                                {
                                    "id": userUUID,
                                    "alterId": 0,
                                    "email": "t@t.tt",
                                    "security": "auto",
                                    "encryption": "none",
                                    "flow": ""
                                }
                            ]
                        }
                    ]
                },
                "streamSettings": {
                    "network": "ws",
                    "security": tls ? "tls" : "none",
                    "tlsSettings": {
                        "allowInsecure": allowInsecure ? "true" : "false",
                        "serverName": randomizedDomain,
                        "alpn": [
                            "h2",
                            "http/1.1",
                            "fakedns"
                        ],
                        "fingerprint": "chrome",
                        "show": false
                    },
                    "wsSettings": {
                        "path": randomPath,
                        "headers": {
                            "Host": randomizedDomain
                        }
                    },
                    "sockopt": {
                        "dialerProxy": "fragment",
                        "tcpKeepAliveIdle": 100,
                        "mark": 255,
                        "tcpNoDelay": allowEarlyData ? "true" : "false",
                    }
                },
                "mux": {
                    "enabled": mux ? "true" : "false",
                    "concurrency": mux ? 8 : -1 
                }
            },
            {
                "tag": "fragment",
                "protocol": "freedom",
                "settings": {
                    "domainStrategy": "AsIs",
                    "fragment": {
                        "packets": tls ? "tlshello" : "1-1",
                        "length": tls ? "10-20" : "1-3",
                        "interval": tls ? "10-20" : "5"
                    }
                },
                "streamSettings": {
                    "sockopt": {
                        "tcpNoDelay": allowEarlyData ? "true" : "false",
                        "tcpKeepAliveIdle": 100
                    }
                }
            },
            {
                "tag": "direct",
                "protocol": "freedom",
                "settings": {}
            },
            {
                "tag": "block",
                "protocol": "blackhole",
                "settings": {
                    "response": {
                        "type": "http"
                    }
                }
            }
        ],
        "routing": {
            "domainStrategy": "AsIs",
            "rules": [
                {
                    "type": "field",
                    "inboundTag": [
                        "api"
                    ],
                    "outboundTag": "api",
                    "enabled": true
                },
                {
                    "id": "5465425548310166497",
                    "type": "field",
                    "outboundTag": "direct",
                    "domain": [
                        "domain:ir",
                        "geosite:cn"
                    ],
                    "enabled": block ? "true" : "false"
                },
                {
                    "id": "5425034033205580637",
                    "type": "field",
                    "outboundTag": "direct",
                    "ip": [
                        "geoip:private",
                        "geoip:cn",
                        "geoip:ir"
                    ],
                    "enabled": block ? "true" : "false"
                },
                {
                    "id": "5627785659655799759",
                    "type": "field",
                    "port": "0-65535",
                    "outboundTag": "proxy",
                    "enabled": true
                }
            ]
        }
    };

        const configOutput = document.getElementById('configOutput');
        configOutput.innerText = JSON.stringify(config, null, 4);
        configOutput.parentElement.classList.add('config-output-container');
    
        const downloadButton = document.getElementById('downloadButton');
        downloadButton.removeAttribute('disabled');
    }
        
    function downloadConfig() {
        const configOutput = document.getElementById('configOutput').innerText;
        const blob = new Blob([configOutput], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'config.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }


    function generateRandomString(length, characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789') {
        let result = '';
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
    }
</script>
</body>
</html>
